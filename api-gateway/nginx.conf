# ============================================================================
# API Gateway Nginx Configuration
# ============================================================================
# Educational Note: This acts as a reverse proxy and API gateway for all microservices
# 
# Benefits:
# - Single entry point for all services (port 80)
# - Request routing to appropriate backend services
# - Load balancing (when multiple instances exist)
# - SSL/TLS termination (in production)
# - Rate limiting (prevent abuse)
# - Request/response logging (monitoring)
# - CORS handling (cross-origin requests)
# - Static file serving (Django admin assets)
# - Health check aggregation
# 
# Architecture:
#   Client → API Gateway (Nginx) → Backend Services
#                                → Frontend (React)
# ============================================================================

events {
    # Maximum number of simultaneous connections per worker process
    # Educational Note: Nginx uses event-driven architecture for high performance
    # Each worker can handle thousands of connections efficiently
    worker_connections 1024;
}

http {
    # ========================================================================
    # Logging Configuration
    # ========================================================================
    # Educational Note: Logs are essential for debugging and monitoring
    # - access_log: Records all requests (who, what, when, status)
    # - error_log: Records errors and warnings
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
    
    # ========================================================================
    # Upstream Services Configuration
    # ========================================================================
    # Educational Note: Upstreams define backend services that Nginx proxies to
    # Benefits:
    # - Named references (easier to maintain)
    # - Load balancing across multiple instances
    # - Health checks and failover
    # - Connection pooling
    
    upstream user_service {
        # UserService handles authentication and user management
        server user-service:8000;
        # For load balancing, add more servers:
        # server user-service-2:8000;
        # server user-service-3:8000;
        
        # Keep connections alive for better performance
        keepalive 32;
    }
    
    upstream product_service {
        # ProductService handles product catalog and inventory
        server product-service:8000;
        keepalive 32;
    }
    
    upstream order_service {
        # OrderService handles order creation and management
        server order-service:8000;
        keepalive 32;
    }
    
    upstream frontend {
        # Frontend serves the React application
        server frontend:3000;
    }
    
    # ========================================================================
    # Main Server Block
    # ========================================================================
    server {
        listen 80;
        server_name localhost;
        
        # ====================================================================
        # Buffer and Size Limits
        # ====================================================================
        # Educational Note: These settings control request/response buffering
        # - Prevents memory exhaustion from large requests
        # - Improves performance for large responses
        # - Adjust based on your application needs
        
        client_max_body_size 10M;          # Maximum request body (file uploads)
        client_body_buffer_size 128k;      # Buffer for request body
        proxy_buffer_size 128k;            # Buffer for response headers
        proxy_buffers 4 256k;              # Buffers for response body
        proxy_busy_buffers_size 256k;      # Maximum busy buffer size
        
        # ====================================================================
        # CORS (Cross-Origin Resource Sharing) Headers
        # ====================================================================
        # Educational Note: CORS allows frontend (different origin) to make API requests
        # 
        # Why needed:
        # - Browser security prevents cross-origin requests by default
        # - Frontend (localhost:3000) needs to call API (localhost:80)
        # - CORS headers tell browser these requests are allowed
        # 
        # Production Note: Replace '*' with specific allowed origins for security
        # Example: 'https://yourdomain.com' instead of '*'
        
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;
        add_header 'Access-Control-Max-Age' 1728000 always;  # Cache preflight for 20 days
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
        
        # Handle preflight OPTIONS requests
        # Educational Note: Browsers send OPTIONS request before actual request
        # to check if CORS is allowed. We respond with 204 No Content.
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # ====================================================================
        # Frontend (React Application)
        # ====================================================================
        # Educational Note: Serves the React SPA and handles client-side routing
        # - All non-API routes go to frontend
        # - Frontend handles routing internally (React Router)
        # - WebSocket support for HMR (Hot Module Replacement) in development
        
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            
            # WebSocket support (for Vite HMR in development)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_cache_bypass $http_upgrade;
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # ====================================================================
        # UserService API Routes
        # ====================================================================
        # Educational Note: UserService handles:
        # - User registration and authentication
        # - JWT token generation (RS256 with RSA keys)
        # - Two-factor authentication (TOTP + backup tokens)
        # - Public key distribution for JWT verification
        # - User profile management
        
        # User management endpoints
        # Routes: /api/users/, /api/users/me/, /api/users/2fa/*
        location /api/users {
            proxy_pass http://user_service/api/users;
            proxy_http_version 1.1;
            proxy_set_header Connection "";  # Enable keepalive
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts (2FA operations can take longer)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # JWT token endpoints
        # Routes: /api/token/ (obtain), /api/token/refresh/
        location /api/token {
            proxy_pass http://user_service/api/token;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Shorter timeout for token operations
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # Public key endpoint (for JWT verification by other services)
        # Route: /api/auth/public-key/
        location /api/auth {
            proxy_pass http://user_service/api/auth;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Cache public key for 5 minutes (it rarely changes)
            proxy_cache_valid 200 5m;
            add_header X-Cache-Status $upstream_cache_status;
        }
        
        # ====================================================================
        # ProductService API Routes
        # ====================================================================
        # Educational Note: ProductService handles:
        # - Product catalog management
        # - Inventory tracking
        # - Product search and filtering
        # - JWT verification with public key (no UserService call!)
        
        # Product endpoints
        # Routes: /api/products/, /api/products/{id}/
        location /api/products {
            proxy_pass http://product_service/api/products;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # Optional: Cache GET requests for product listings
            # Uncomment for production to reduce database load
            # proxy_cache_valid 200 2m;
            # proxy_cache_key "$scheme$request_method$host$request_uri";
            # add_header X-Cache-Status $upstream_cache_status;
        }
        
        # ====================================================================
        # OrderService API Routes
        # ====================================================================
        # Educational Note: OrderService handles:
        # - Order creation and management
        # - Cross-service validation (User + Product via gRPC)
        # - Encrypted sensitive data storage
        # - Resilience patterns (retry + circuit breaker)
        
        # Order endpoints
        # Routes: /api/orders/, /api/orders/{id}/, /api/orders/user/{user_id}/
        location /api/orders {
            proxy_pass http://order_service/api/orders;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Longer timeout for order creation (gRPC calls to multiple services)
            proxy_connect_timeout 90s;
            proxy_send_timeout 90s;
            proxy_read_timeout 90s;
        }
        
        # ====================================================================
        # Health Check Endpoints
        # ====================================================================
        # Educational Note: Health checks are essential for:
        # - Docker health checks (container orchestration)
        # - Load balancer routing decisions
        # - Monitoring and alerting systems
        # - Service discovery
        
        # Individual service health checks
        location /health/user {
            proxy_pass http://user_service/health/;
            proxy_set_header Host $host;
            access_log off;  # Don't log health checks
        }
        
        location /health/product {
            proxy_pass http://product_service/health/;
            proxy_set_header Host $host;
            access_log off;
        }
        
        location /health/order {
            proxy_pass http://order_service/health/;
            proxy_set_header Host $host;
            access_log off;
        }
        
        # API Gateway health check
        location /health {
            access_log off;
            return 200 "API Gateway is healthy\n";
            add_header Content-Type text/plain;
        }
        
        # ====================================================================
        # Django Admin Interfaces
        # ====================================================================
        # Educational Note: Django admin provides web interface for data management
        # - Useful for debugging and manual data operations
        # - Each service has its own admin at /admin/{service}/
        # - Requires superuser credentials
        
        # UserService admin
        location ~ ^/admin/user(/.*)?$ {
            proxy_pass http://user_service/admin$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # ProductService admin
        location ~ ^/admin/product(/.*)?$ {
            proxy_pass http://product_service/admin$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # OrderService admin
        location ~ ^/admin/order(/.*)?$ {
            proxy_pass http://order_service/admin$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Static files for Django admin
        # Educational Note: Django admin requires static files (CSS, JS) to work properly
        location /static/user/ {
            alias /var/www/static/user/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        location /static/product/ {
            alias /var/www/static/product/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        location /static/order/ {
            alias /var/www/static/order/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # Swagger/OpenAPI
        # Educational Note: API documentation generated by drf-spectacular
        location /docs/user {
            proxy_pass http://user_service/api/docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /docs/product {
            proxy_pass http://product_service/api/docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /docs/order {
            proxy_pass http://order_service/api/docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
